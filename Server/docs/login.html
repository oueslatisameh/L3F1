<!DOCTYPE html>

<html>
<head>
  <title>login.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="Faddress.html">
                Faddress.js
              </a>
            
              
              <a class="source" href="Fshop.html">
                Fshop.js
              </a>
            
              
              <a class="source" href="about.html">
                about.js
              </a>
            
              
              <a class="source" href="account.html">
                account.js
              </a>
            
              
              <a class="source" href="admin.html">
                admin.js
              </a>
            
              
              <a class="source" href="card.html">
                card.js
              </a>
            
              
              <a class="source" href="home.html">
                home.js
              </a>
            
              
              <a class="source" href="list.html">
                list.js
              </a>
            
              
              <a class="source" href="login.html">
                login.js
              </a>
            
              
              <a class="source" href="logout.html">
                logout.js
              </a>
            
              
              <a class="source" href="product.html">
                product.js
              </a>
            
              
              <a class="source" href="recovery.html">
                recovery.js
              </a>
            
              
              <a class="source" href="registration.html">
                registration.js
              </a>
            
              
              <a class="source" href="shop.html">
                shop.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>login.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <table border="1">
<tr>
    <th>routes ajoutées dans</th> <th><a href="app.html"><b>app.js</b></a></th>
</tr>
</table>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Ajout des modules node.js</p>
<ul>
<li>  <a href="https://github.com/chriso/node-validator"><b>Validator</b></a> : ensemble de fonction de format de String</li>
<li>  <a href="http://nodejs.org/api/crypto.html"><b>Crypto</b></a> : ensemble de fonction pour la cryptographie</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);
<span class="hljs-keyword">var</span> validator = <span class="hljs-built_in">require</span>(<span class="hljs-string">'validator'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><b>isEmpty</b>: fonction vérifiant si un objet est nulle ou non</p>
<ul>
<li>paramètre</li>
<ul>
    <li><b>obj</b> : un objet quelconque</li>
</ul>
<li>sortie</li>
<ul>
    <li><b>true</b> si l’objet est vide (ex: “”, [], {})</li>
    <li><b>false</b> si l’objet n’est pas vide</li>
</ul>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isEmpty</span><span class="hljs-params">(obj)</span> {</span>
  <span class="hljs-keyword">if</span> (obj === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">if</span> (obj.length &gt; <span class="hljs-number">0</span>)    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">if</span> (obj.length === <span class="hljs-number">0</span>)  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> obj) {
    <span class="hljs-keyword">if</span> (hasOwnProperty.call(obj, key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Route GET <b>/login</b><br />
<small>route renvoyant une page pour se connecter</small>  </p>
<ul>
<li>sortie</li>
<ul>
    <li><b>Page HTML</b> : login</li>
</ul>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.getLogin = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(config)</span> {</span>
	<span class="hljs-keyword">return</span> (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res)</span> {</span>
		res.render(<span class="hljs-string">'login'</span>, {web : config.web});
	});
};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Route GET <b>/login/:id</b><br />
<small>lorsque l’utilisateur clique dans le lien de l’email envoyé après l’enregistrement
(cf. la route postRegistration dans <a href="registration.html"><b>registration.js</b></a>) les informations dans Redis
sont enregistré dans postgreSQL. Si l’utilisateur a mis son adresse, son code postal et sa ville
alors une adresse favorite est automatiquement ajouté</small>  </p>
<ul>
<li>paramètre</li>
<ul>
    <li><b>id</b> : numéro unique créé avec crypto</li>
</ul>
<li>sortie</li>
<ul>
    <li><b>Page HTML</b> : login</li>
</ul>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.getLoginId = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(config, redisfunc, query_nominatim, queryStatIncr, pg, errorGes)</span> {</span>
	<span class="hljs-keyword">return</span>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res)</span> {</span>
		<span class="hljs-keyword">var</span> asyncWaterfall = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>);
		<span class="hljs-keyword">var</span> user = req.get(<span class="hljs-string">'user-agent'</span>);
		asyncWaterfall.waterfall([ <span class="hljs-comment">// création d'un waterfall servant à imbriquer des fonctions</span>
			<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
				redisfunc(req.params.id, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, resultUser)</span> {</span>
					<span class="hljs-keyword">if</span> (!err) {
						callback(<span class="hljs-literal">null</span>, resultUser);
					} <span class="hljs-keyword">else</span> {
						callback(err);
					}
				});
			},
			<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r, callback)</span> {</span>
				<span class="hljs-keyword">var</span> queryLogin = <span class="hljs-string">"INSERT INTO users values(\'"</span> + r.email + <span class="hljs-string">"\',\'"</span> + r.password + <span class="hljs-string">"\',\'"</span> +
				r.name + <span class="hljs-string">"\',"</span> + (r.forename == <span class="hljs-string">' '</span> ? <span class="hljs-string">"null"</span> : <span class="hljs-string">"\'"</span> + r.forename + <span class="hljs-string">"\'"</span>) +
				<span class="hljs-string">","</span> + (r.birth == <span class="hljs-string">' '</span> ? <span class="hljs-string">"null"</span> : <span class="hljs-string">"\'"</span> + r.birth + <span class="hljs-string">"\'"</span>)+ <span class="hljs-comment">// création de la requête à postgreSQL</span>
				<span class="hljs-string">","</span> + (r.address == <span class="hljs-string">' '</span> ? <span class="hljs-string">"null"</span> : <span class="hljs-string">"\'"</span> + r.address + <span class="hljs-string">"\'"</span>)+
				<span class="hljs-string">","</span> + (r.postcode == <span class="hljs-string">' '</span> ? <span class="hljs-string">"null"</span> : <span class="hljs-string">"\'"</span> + r.postcode + <span class="hljs-string">"\'"</span>)+
				<span class="hljs-string">","</span> + (r.town == <span class="hljs-string">' '</span> ? <span class="hljs-string">"null"</span> : <span class="hljs-string">"\'"</span> + r.town + <span class="hljs-string">"\'"</span>)+
				<span class="hljs-string">");"</span>;
				pg(queryLogin, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, resultPG)</span> {</span>
					<span class="hljs-keyword">if</span> (!err &amp;&amp; r.address != <span class="hljs-string">' '</span> &amp;&amp; r.town != <span class="hljs-string">' '</span> &amp;&amp; r.postcode != <span class="hljs-string">' '</span>) {
						<span class="hljs-comment">/* si les informations entrées par l'utilisateur lors de son inscription 
						contenaient l'adresse, le code postal et la ville alors une recherche sur 
						le serveur nominatim est effectuer pour récupéré la longitude et la latitude et 
						d'autres informations pour pouvoir créer automatiquement une adresse favorite*/</span>
						<span class="hljs-keyword">var</span> epic = {road : r.address, town : r.town, postcode : r.postcode, email : r.email};
						query_nominatim(epic, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, queryAddress)</span> {</span>
							<span class="hljs-keyword">if</span> (!err) {
								pg(queryAddress, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, resultPut)</span> {</span> <span class="hljs-comment">// l'adresse favorite est ajouté dans la base données</span>
									<span class="hljs-keyword">if</span> (!err) {callback(<span class="hljs-literal">null</span>, resultPut);}
									<span class="hljs-keyword">else</span> {callback(err);} <span class="hljs-comment">// redirection vers home</span>
								});
							} <span class="hljs-keyword">else</span> {callback(err);}
						});
					} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!err) {
						callback(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
					} <span class="hljs-keyword">else</span> {
						callback(err);
					}
				});
			},
			<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(finish, callback)</span> {</span>
				queryStatIncr(<span class="hljs-string">"registration"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, resultStatIncr)</span> {</span>
					<span class="hljs-comment">/* incrémentation de la variable registration
					dans Redis pour les statistiques*/</span>
					<span class="hljs-keyword">if</span> (!err) {
						callback(<span class="hljs-literal">null</span>, (finish || resultStatIncr));
					} <span class="hljs-keyword">else</span> {
						callback(err);
					}
				});
			}
		], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, result)</span> {</span>
			<span class="hljs-keyword">if</span> (!err) {
				res.redirect(<span class="hljs-string">'/'</span>);
			} <span class="hljs-keyword">else</span> {
				errorGes(user, res, <span class="hljs-string">'login'</span>, [err]);
			}
		});
	});
};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Route POST <b>/login</b><br />
<small>si la valeur des champs email et password sont dans la base de données, alors 
un objet contenant l’email est envoyé a Redis avec une date d’expiration et un cookie avec 
le même temps est envoyé au client afin qu’il puisse accéder aux autres services du serveur</small></p>
<ul>
<li>paramètre</li>
<ul>
    <li><b>email</b> : l’adresse email</li>
    <li><b>password</b> : hash du mot de passe</li>
</ul>
<li>sortie</li>
<ul>
    <li><b>document JSON</b> : confirmation de la requête</li>
    <li><b>page HTML</b> : home</li>
    <li><b>cookie signé</b> : contenant un identifiant unique vérifié à chaque requête vers les routes 
     contenant le middleware ensureAuthenticated (cf : les routes dans <a href="app.html"><b>app.js</b></a>)</li>
</ul>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.postLogin = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(config, clientRedis, queryStatIncr, pg, errorGes)</span> {</span>
	<span class="hljs-keyword">return</span> (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req,res)</span> {</span>
		<span class="hljs-keyword">var</span> user = req.get(<span class="hljs-string">"user-agent"</span>);
		<span class="hljs-keyword">var</span> error = [];
		<span class="hljs-keyword">var</span> wherefrom = (user == <span class="hljs-string">'scanoid/1.0'</span>) ? <span class="hljs-string">'app'</span> : <span class="hljs-string">'web'</span>;
		<span class="hljs-keyword">if</span> (!req.body.email) <span class="hljs-comment">// vérification des champs récupérés</span>
			error.push(config.stringRL.missingEmail);
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (validator.isEmail(req.body.email) === <span class="hljs-literal">false</span>)
			error.push(config.stringRL.formEmail);
		<span class="hljs-keyword">if</span> (!req.body.password)
			error.push(config.stringRL.missingPassword);
		<span class="hljs-keyword">if</span> (error.length === <span class="hljs-number">0</span>) {
			<span class="hljs-keyword">var</span> asyncWaterfall = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>);
			asyncWaterfall.waterfall([
				<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
					crypto.randomBytes(config.misc.sizeRandomEmail, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ex, buf)</span> {</span>
						callback(<span class="hljs-literal">null</span>, buf.toString(<span class="hljs-string">'hex'</span>).substr(<span class="hljs-number">0</span>, config.misc.sizeRandomEmail));
					});
				},
				<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(buf, callback)</span> {</span>
					<span class="hljs-keyword">var</span> sh = crypto.createHash(<span class="hljs-string">'sha1'</span>).update(req.body.password).digest(<span class="hljs-string">'hex'</span>); <span class="hljs-comment">// création du hash du mot de passe</span>
					<span class="hljs-keyword">var</span> queryLogin = <span class="hljs-string">'SELECT user_email,user_password FROM users WHERE user_email=\''</span>+ <span class="hljs-comment">// création de la requête à postgreSQL</span>
						req.body.email +<span class="hljs-string">'\' AND user_password=\''</span>+ sh +<span class="hljs-string">'\';'</span>;
					pg(queryLogin, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, resultL)</span> {</span>
						<span class="hljs-keyword">if</span> (!err &amp;&amp; resultL.rows.length === <span class="hljs-number">0</span>) {
							callback(config.stringRL.login);
						} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!err) {
							callback(<span class="hljs-literal">null</span>, buf);
						} <span class="hljs-keyword">else</span> {
							callback(err);
						}
					});
				},
				<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(buf, callback)</span> {</span>
					clientRedis.set(wherefrom + <span class="hljs-string">":"</span> + buf, req.body.email, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, resp)</span> {</span> <span class="hljs-comment">// envoit d'un objet dans Redis numéro aléatoire + mot de passe</span>
						<span class="hljs-keyword">if</span> (!err) {
							res.cookie(<span class="hljs-string">'name'</span>, wherefrom + <span class="hljs-string">":"</span> + buf, {httpOnly: <span class="hljs-literal">true</span>, signed : <span class="hljs-literal">true</span>}); <span class="hljs-comment">// création du cookie pour le client </span>
							<span class="hljs-keyword">if</span> (user == <span class="hljs-string">'scanoid/1.0'</span>) {<span class="hljs-comment">// si l'utilisateur est sur l'application Android pas de date d'expiration</span>
								callback(<span class="hljs-literal">null</span>, buf);
							} <span class="hljs-keyword">else</span> {
								clientRedis.expire(wherefrom + <span class="hljs-string">":"</span> + buf, config.misc.timeConnexion, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err2, resp2)</span> {</span>
									<span class="hljs-comment">/* mise en place d'une date d'expiration pour l'entree dans Redis*/</span>
									<span class="hljs-keyword">if</span> (!err) {
										callback(<span class="hljs-literal">null</span>, resp2);
									} <span class="hljs-keyword">else</span> {
										callback(err2); <span class="hljs-comment">// redirection vers home si tout c'est bien passé</span>
									}
								});
							}
						}
						<span class="hljs-keyword">if</span> (err) {
							callback(err);
						}
					});
				},
				<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(finish, callback)</span> {</span>
					queryStatIncr(<span class="hljs-string">"connection"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, resultStatIncr)</span> {</span> 
						<span class="hljs-comment">/* incrémentation de la variable connection
						dans Redis pour les statistiques*/</span>
						<span class="hljs-keyword">if</span> (!err) {
							callback(<span class="hljs-literal">null</span>, finish);
						} <span class="hljs-keyword">else</span> {
							callback(err);
						}
					});
				}
			], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, finish)</span> {</span>
				<span class="hljs-keyword">if</span> (!err &amp;&amp; user == <span class="hljs-string">'scanoid/1.0'</span>) {
					res.json({registered : <span class="hljs-string">"success"</span>, code : wherefrom + <span class="hljs-string">":"</span> + finish}); <span class="hljs-comment">// envoit de la confirmation</span>
				} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!err) {
					res.redirect(<span class="hljs-string">'/'</span>);
				} <span class="hljs-keyword">else</span> {
					errorGes(user, res, <span class="hljs-string">'login'</span>, [err]);
				}
			});
		} <span class="hljs-keyword">else</span> {
			errorGes(user, res, <span class="hljs-string">'login'</span>, error);
		}
	});	
};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Route POST <b>/loginFacebook</b><br />
<small>reçoit les champs du formulaire de connexion facebook envoyé par l’application Android,
si l’utilisateur est déjà inscrit sur le site alors un cookie est envoyé comme postLogin. si
l’utilisateur n’est pas inscrit sur l’application scanOID alors avant d’envoyé un cookie signé,
une entrée est créée dans la base postgreSQL avant d’envoyer le cookie signé </small></p>
<ul>
<li>paramètre</li>
<ul>
    <li><b>name</b> : nom de l’utilisateur</li>
    <li><b>forename</b> : prénom de l’utilisateur</li>
    <li><b>email</b> : l’adresse email</li>
    <li><b>id</b> : hash de l’id donné par facebook à l’utilisateur</li>
    <li><b>birth</b> : date de naissance</li>
</ul>
<li>sortie</li>
<ul>
    <li><b>document JSON</b> : confirmation de la requête</li>
    <li><b>cookie signé</b> : contenant un identifiant unique vérifié à chaque requête vers les routes 
        contenant le middleware ensureAuthenticated (cf : les routes dans <a href="app.html"><b>app.js</b></a>)</li>
</ul>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.postLoginFacebook = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(config, pg, errorGes)</span> {</span>
	<span class="hljs-keyword">return</span> (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res)</span> {</span>
		<span class="hljs-keyword">var</span> user = req.get(<span class="hljs-string">"user-agent"</span>);
		<span class="hljs-keyword">var</span> wherefrom = (user == <span class="hljs-string">'scanoid/1.0'</span>) ? <span class="hljs-string">'app'</span> : <span class="hljs-string">'web'</span>;
		
		<span class="hljs-keyword">var</span> loggFacebook = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
			<span class="hljs-comment">/* définition de la fonction pour créé une entrée avec une date 
			d'expiration dans Redis et un cookie signé à envoyé au client*/</span>
			crypto.randomBytes(config.misc.sizeRandomEmail, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ex, buf)</span> {</span>
				buf = buf.toString(<span class="hljs-string">'hex'</span>).substr(<span class="hljs-number">0</span>, config.misc.sizeRandomEmail);
				clientRedis.set(wherefrom + <span class="hljs-string">":"</span> + buf, req.body.email, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, resp)</span> {</span>
					<span class="hljs-keyword">if</span> (err) {errorGes(user, res, <span class="hljs-string">'login'</span>);}
					<span class="hljs-keyword">else</span> {
						res.cookie(<span class="hljs-string">'name'</span>, wherefrom + <span class="hljs-string">":"</span> + buf, {httpOnly: <span class="hljs-literal">true</span>, signed : <span class="hljs-literal">true</span>}); <span class="hljs-comment">// création du cookie</span>
						<span class="hljs-keyword">if</span> (user == <span class="hljs-string">'scanoid/1.0'</span>)  <span class="hljs-comment">// si l'utilisateur est sur l'application Android pas de date d'expiration</span>
							res.json({registered : <span class="hljs-string">"success"</span>, code : wherefrom + <span class="hljs-string">":"</span> + buf});
						<span class="hljs-keyword">else</span> {
							clientRedis.expire(wherefrom + <span class="hljs-string">":"</span> + buf, config.misc.timeConnexion, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, resp)</span> {</span> <span class="hljs-comment">// date d'expiration</span>
								<span class="hljs-keyword">if</span> (err) {errorGes(user, res, <span class="hljs-string">'login'</span>);}
								<span class="hljs-keyword">else</span>
									res.redirect(<span class="hljs-string">'/'</span>); <span class="hljs-comment">// redirection vers home</span>
							});
						}
					}
				});			
			});		
		};
		
		<span class="hljs-keyword">var</span> queryEmail = <span class="hljs-string">"SELECT * FROM users where user_email = \'"</span> + req.body.email + <span class="hljs-string">"\';"</span>;
		pg(queryEmail , <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, re)</span> {</span> <span class="hljs-comment">// vérification de la présence de l'email dans la base</span>
			<span class="hljs-keyword">if</span> (err) {errorGes(user, res, <span class="hljs-string">'login'</span>);}
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (re.rows.length !== <span class="hljs-number">0</span>) { <span class="hljs-comment">// l'email existe dans la base</span>
				queryEmail = <span class="hljs-string">"SELECT * FROM users where user_email = \'"</span> + req.body.email +
				<span class="hljs-string">"\' AND user_password = \'"</span> + req.body.password + <span class="hljs-string">"\';"</span>;
				pg(queryEmail, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, resultat)</span> {</span>  <span class="hljs-comment">// vérification de l'association adresse email password dans postgreSQL</span>
					<span class="hljs-keyword">if</span> (err || resultat.rows.length === <span class="hljs-number">0</span>) {errorGes(user, res, <span class="hljs-string">'login'</span>);}
					<span class="hljs-keyword">else</span>
						loggFacebook(); <span class="hljs-comment">// si pas d'erreur</span>
				});
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-keyword">var</span> queryRegistration = <span class="hljs-string">"INSERT INTO users values(\'"</span> + req.body.email  + <span class="hljs-comment">// création de la requête postgreSQL</span>
				<span class="hljs-string">"\',\'"</span> + req.password.password + <span class="hljs-string">"\',\'"</span>+
				req.body.name + <span class="hljs-string">"\',\'"</span> + req.body.forename + <span class="hljs-string">"\'"</span> +
				<span class="hljs-string">","</span> + (req.body.birth == <span class="hljs-string">' '</span> ? <span class="hljs-string">"null"</span> : <span class="hljs-string">"\'"</span> + req.body.birth + <span class="hljs-string">"\'"</span>)+
				<span class="hljs-string">");"</span>;
				pg(queryRegistration, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, resultat)</span> {</span> <span class="hljs-comment">// requête pour entrer le nouvelle utilisateur facebook</span>
					<span class="hljs-keyword">if</span> (!err) {loggFacebook();} <span class="hljs-comment">// si pas d'erreur</span>
					<span class="hljs-keyword">else</span>
						errorGes(user, res, <span class="hljs-string">'login'</span>);
				});				
			}
		});
	});
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
